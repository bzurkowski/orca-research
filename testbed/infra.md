# Infrastructure Setup

## Host machine preparation

### Initial setup

Set hostname:

```
$ hostnamectl set-hostname phd1
```

Fix locale:

```
$ vi /etc/environment
LANG=en_US.utf-8
LC_ALL=en_US.utf-8
```

Setup basic packages:

```bash
$ yum install -y wget vim git htop curl
```

### Network interfaces

Setup network bridge for external interface (`enp6s0`):

```bash
$ vi /etc/sysconfig/network-scripts/ifcfg-enp6s0
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="none"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="enp6s0"
UUID="5e5822dd-dc88-42dd-98cd-31628d4404bf"
DEVICE="enp6s0"
ONBOOT="yes"
BRIDGE="br0"
```

```bash
$ vi /etc/sysconfig/network-scripts/ifcfg-br0
DEVICE="br0"
BOOTPROTO="static"
ONBOOT="yes"
TYPE="Bridge"
IPADDR="172.17.80.25"
PREFIX="24"
GATEWAY="172.17.80.254"
DNS1="172.29.128.101"
```

Setup network bridge for internal interface (`enp7s0`):

```bash
$ vi /etc/sysconfig/network-scripts/ifcfg-enp7s0
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="enp7s0"
UUID="0674f835-ed1d-479f-8ad8-9ed253588189"
DEVICE="enp7s0"
ONBOOT="yes"
BRIDGE="br1"
```

```bash
$ vi /etc/sysconfig/network-scripts/ifcfg-br1
DEVICE="br1"
BOOTPROTO="static"
ONBOOT="yes"
TYPE="Bridge"
IPADDR="10.10.10.25"
PREFIX="24"
```

Reboot the OS:

```
$ reboot
```

### Setup KVM

Enable nested virtualization:

```bash
$ cat /sys/module/kvm_intel/parameters/nested
N
```

```bash
$ vi /etc/modprobe.d/kvm-nested.conf
options kvm-intel nested=1
options kvm-intel enable_shadow_vmcs=1
options kvm-intel enable_apicv=1
options kvm-intel ept=1
```

```bash
$ modprobe -r kvm_intel
$ modprobe -a kvm_intel
```

```bash
$ cat /sys/module/kvm_intel/parameters/nested
Y
```

Install KVM:

```bash
$ yum -y install qemu-kvm libvirt libvirt-python libguestfs-tools virt-install
```

Enable Libvirt daemon:

```bash
$ systemctl enable libvirtd
$ systemctl start libvirtd
```

Ensure the KVM module is loaded into Kernel:

```bash
$ lsmod | grep -i kvm
kvm_intel             183621  0
kvm                   586948  1 kvm_intel
```

## VM provisioning

### Prepare Kickstart files

Create Kickstart file for each VM:

```bash
$ vi /var/www/html/kickstart/orca1.cfg
```

```
#Generated by Kickstart Configurator
#platform=x86

#System language
lang en_US

#System keyboard
keyboard pl

#System timezone
timezone Europe/Warsaw

#Root password
rootpw --iscrypted $1$tSjV83cV$yl5tDtV7YuCMGthbK0pKf1

#Reboot after installation
reboot

#Install OS instead of upgrade
install

#Use CDROM installation media
cdrom

#System bootloader configuration
bootloader --location=mbr

#Clear the Master Boot Record
zerombr yes

#Partition clearing information
clearpart --all --initlabel

#Disk partitioning information
part /boot --fstype ext4 --size 1024
part / --fstype ext4 --size 10240

#System authorization infomation
auth  --useshadow  --enablemd5

#Network information
network --bootproto=static --ip=172.17.66.31 --netmask=255.255.255.0 --gateway=172.17.66.254 --nameserver=172.29.128.101,8.8.8.8 --device=eth0
network --bootproto=static --ip=10.10.10.31 --netmask=255.255.255.0 --gateway=10.10.10.1 --nameserver=8.8.8.8 --device=eth1

#Firewall configuration
firewall --disabled

#Do not configure the X Window System
skipx
```

### Setup httpd

Install the HTTP server:

```bash
$ yum install httpd
```

Start the server.

```bash
$ systemctl enable httpd
$ systemctl start httpd
```

Open HTTP port:

```bash
$ firewall-cmd --permanent --add-service http
$ firewall-cmd --add-service http
```

Create directory for Kickstart files:

```bash
$ mkdir -p /var/www/html/kickstart
$ chown apache:apache /var/www/html/kickstart
$ chmod 750 /var/www/html/kickstart
```

Move all Kickstart files:

```bash
$ mv orca*.cfg /var/www/html/kickstart/
```

### Provision VMs

Provision VM instance:

```bash
virt-install \
    --virt-type=kvm \
    --name orca1 \
    --ram 4096 \
    --vcpus=2 \
    --cpu host \
    --os-type=linux \
    --os-variant=centos7.0 \
    --location=/home/libvirt/images/CentOS-7-x86_64-Minimal-2009.iso \
    --network=bridge=br0,model=virtio \
    --network=bridge=br1,model=virtio \
    --disk path=/home/libvirt/images/orca1.raw,size=10,bus=virtio,format=raw \
    --graphics vnc \
    --initrd-inject=/var/www/html/kickstart/orca1.cfg \
    --extra-args "ks=file:/orca1.cfg"
```

Find VNC port:

```bash
$ virsh dumpxml centos7 | grep vnc
<graphics type='vnc' port='5901' autoport='yes' listen='127.0.0.1'>
```

Port-forward the VNC port:

```
$ ssh root@172.17.80.22 -L 5900:127.0.0.1:5900
```

Access the OS installation via VNC Viewer.

#### Links

* https://www.cyberciti.biz/faq/how-to-install-kvm-on-centos-7-rhel-7-headless-server/
* https://www.cyberciti.biz/faq/kvm-install-centos-redhat-using-kickstart-ks-cfg/
